# ç›´æ’­è¾©è®ºç³»ç»Ÿ (Live Debate System)

## ğŸ“Œ åŸºæœ¬ä¿¡æ¯

- **é¡¹ç›®åç§°**: ç›´æ’­è¾©è®ºåç«¯æœåŠ¡ (Live Debate Backend Service)

## ğŸš€ æ¼”ç¤ºåœ°å€

- **å‰ç«¯è®¿é—®åœ°å€ï¼ˆåå°ç®¡ç†ï¼‰**: http://localhost:8080/admin
  - å…¬ç½‘è®¿é—®éœ€é…åˆå†…ç½‘ç©¿é€å·¥å…·ï¼ˆå¦‚ Ngrok/Frpï¼‰æ˜ å°„ 8080 ç«¯å£ã€‚
- **åç«¯ API åœ°å€**: 
  - ç½‘å…³ä»£ç†åœ°å€: http://localhost:8080/api
  - ç›´è¿åœ°å€: http://localhost:8081/api

## ğŸ§± æŠ€æœ¯æ ˆè¯´æ˜

- **åç«¯æ¡†æ¶**: 
  - **Java**: JDK 17
  - **Framework**: Spring Boot 3.2.0 (Spring Web, Spring WebSocket)
  - **Gateway**: Node.js (Express + http-proxy-middleware v3)

- **Mock æ•°æ®ç”Ÿæˆæ–¹æ¡ˆ**: 
  - **çº¯ä»£ç æ¨¡æ‹Ÿ**: ä½¿ç”¨ Java `ConcurrentHashMap` å­˜å‚¨è¿è¡Œæ—¶çŠ¶æ€ï¼ˆç›´æ’­æµã€è¾©é¢˜ã€ç¥¨æ•°ï¼‰ã€‚
  - **åŠ¨æ€æ›´æ–°**: é€šè¿‡ `MockDataService` é€»è¾‘å¤„ç†æ•°æ®å˜æ›´ï¼ˆå¦‚é˜²æ­¢ ID ä¸¢å¤±ï¼‰ã€‚
  - **å®šæ—¶ä»»åŠ¡**: ä½¿ç”¨ Spring `@Scheduled` æ¨¡æ‹Ÿç¥¨æ•°å®æ—¶å¢é•¿å’Œ AI è§‚ç‚¹ç”Ÿæˆã€‚

- **éƒ¨ç½²å¹³å°ä¸æ–¹å¼**: 
  - **æœ¬åœ°æ··åˆéƒ¨ç½²**: 
    - Java åç«¯è¿è¡Œäº `8081` ç«¯å£ (è´Ÿè´£ä¸šåŠ¡é€»è¾‘ & WebSocket)ã€‚
    - Node.js ç½‘å…³è¿è¡Œäº `8080` ç«¯å£ (è´Ÿè´£é™æ€èµ„æºæœåŠ¡ & åå‘ä»£ç†)ã€‚
    - å‰ç«¯é¡µé¢ç”±ç½‘å…³æ‰˜ç®¡ï¼Œé€šè¿‡ API ä»£ç†è§£å†³è·¨åŸŸé—®é¢˜ã€‚

## ğŸ”— é¡¹ç›®ç»“æ„ä¸æ¥å£è¯´æ˜

### ç®€è¿°åç«¯ç›®å½•ç»“æ„

```
/
â”œâ”€â”€ frontend/             # å‰ç«¯é™æ€èµ„æº (Admin & App)
â”œâ”€â”€ gateway/              # Node.js ç½‘å…³æœåŠ¡
â”‚   â”œâ”€â”€ gateway.js        # ä»£ç†é…ç½®å…¥å£ (æ ¸å¿ƒ)
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ backend/              # Spring Boot åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ src/main/java/com/example/livedebate/
â”‚   â”‚   â”œâ”€â”€ config/       # WebSocket é…ç½® (LiveWebSocketHandler)
â”‚   â”‚   â”œâ”€â”€ controller/   # REST API æ§åˆ¶å™¨ (AdminController, ApiController)
â”‚   â”‚   â”œâ”€â”€ model/        # æ•°æ®å®ä½“ (Stream, Vote, LiveStatus)
â”‚   â”‚   â””â”€â”€ service/      # ä¸šåŠ¡é€»è¾‘ (MockDataService)
â”‚   â””â”€â”€ pom.xml
â””â”€â”€ README.md
```

### ä¸»è¦æ¥å£åˆ—è¡¨

| åŠŸèƒ½ | æ–¹æ³• | è·¯å¾„ | æè¿° |
|---|---|---|---|
| **åå°ç®¡ç†** | | | |
| è·å–ç›´æ’­æµåˆ—è¡¨ | GET | `/api/admin/streams` | è¿”å›é…ç½®çš„ç›´æ’­æµä¿¡æ¯ |
| è·å–ä»ªè¡¨ç›˜æ•°æ® | GET | `/api/admin/dashboard` | åŒ…å«ç¥¨æ•°ã€ç›´æ’­çŠ¶æ€ã€å½“å‰è¾©é¢˜ |
| ç›´æ’­æ§åˆ¶ | POST | `/api/admin/live/control` | æ§åˆ¶ç›´æ’­å¼€å§‹/åœæ­¢ (Payload: `{action: "start/stop"}`) |
| æ›´æ–°è¾©é¢˜ | PUT | `/api/streams/{id}/debate` | ä¿®æ”¹è¾©é¢˜å†…å®¹ |
| **å®¢æˆ·ç«¯/å…¬å…±** | | | |
| è·å–ç¥¨æ•°ç»Ÿè®¡ | GET | `/api/votes/statistics` | è·å–å®æ—¶ç¥¨æ•°åˆ†å¸ƒ |
| WebSocketè¿æ¥ | WS | `/ws` | å»ºç«‹é•¿è¿æ¥ï¼Œæ¥æ”¶å®æ—¶æ¨é€ |
| è·å– AI è§‚ç‚¹ | GET | `/api/ai-content/list` | è·å– AI ç”Ÿæˆçš„è¾©è®ºå†…å®¹ |

## ğŸ§  é¡¹ç›®å¼€å‘è¿‡ç¨‹ç¬”è®°

### ç®€è¿°é¡¹ç›®å®ç°æ€è·¯
1.  **å‰åç«¯åˆ†ç¦»ä¸èåˆ**: é‡‡ç”¨ Java å¤„ç†æ ¸å¿ƒä¸šåŠ¡ï¼Œä¿ç•™åŸæœ‰çš„ Node.js ç½‘å…³ä½œä¸ºâ€œèƒ¶æ°´å±‚â€ï¼Œæ—¢å¤ç”¨äº†å‰ç«¯é™æ€èµ„æºæœåŠ¡ï¼Œåˆå®ç°äº†å‘ Java åç«¯çš„å¹³æ»‘è¿ç§»ã€‚
2.  **WebSocket ä»£ç†ç©¿é€**: å…³é”®åœ¨äºå¦‚ä½•è®© WebSocket è¿æ¥ç©¿è¿‡ Node.js ä»£ç†åˆ°è¾¾ Spring Bootã€‚ä½¿ç”¨äº† `http-proxy-middleware` çš„ `ws: true` æ¨¡å¼ï¼Œå¹¶æ‰‹åŠ¨æ¥ç®¡ `upgrade` äº‹ä»¶ã€‚
3.  **Mock æ•°æ®æœåŠ¡åŒ–**: å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ Service ä¸­ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç åœ¨ Controller é‡Œï¼Œæ¨¡æ‹Ÿäº†çœŸå®æ•°æ®åº“çš„ CRUD æ“ä½œä½“éªŒã€‚

### é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

1.  **WebSocket è¿æ¥å¤±è´¥ (400/404)**
    *   **é—®é¢˜**: å®¢æˆ·ç«¯è¿æ¥ `ws://localhost:8080/ws` æ—¶ä¸æ–­æŠ¥é”™ï¼ŒGateway è¿”å› 400 Bad Request æˆ– 404ã€‚
    *   **åŸå› **: `http-proxy-middleware` v3 ç‰ˆæœ¬ä¸ä¼šè‡ªåŠ¨ç›‘å¬æœåŠ¡å™¨çš„ `upgrade` äº‹ä»¶ï¼›åŒæ—¶ Express çš„è·¯ç”±åŒ¹é…å¯èƒ½å‰¥ç¦»äº†è·¯å¾„ã€‚
    *   **è§£å†³æ–¹æ¡ˆ**: 
        1. åœ¨ `gateway.js` ä¸­æ˜¾å¼æ·»åŠ  `server.on('upgrade', wsProxy.upgrade)`ã€‚
        2. è®¾ç½® `changeOrigin: false` ä»¥ä¿ç•™åŸå§‹ Host å¤´ï¼ˆä¾¿äºåç«¯æ ¡éªŒ Originï¼‰ã€‚
        3. ä½¿ç”¨ `pathFilter` ç²¾ç¡®åŒ¹é… `/ws` è·¯å¾„ï¼Œé¿å…è·¯å¾„è¢«é”™è¯¯é‡å†™ã€‚

2.  **API è·¯å¾„ 404**
    *   **é—®é¢˜**: è®¿é—® `/api/admin/streams` è¿”å› 404ã€‚
    *   **åŸå› **: `pathRewrite` é…ç½®é”™è¯¯å¯¼è‡´è·¯å¾„è¢«æˆªæ–­ï¼ˆå¦‚å˜æˆ `/admin/streams`ï¼‰ï¼Œè€Œåç«¯æœŸæœ› `/api/admin/streams`ã€‚
    *   **è§£å†³æ–¹æ¡ˆ**: ç§»é™¤ `pathRewrite`ï¼Œæ”¹ç”¨ `pathFilter: (path) => path.startsWith('/api')`ï¼Œç¡®ä¿è·¯å¾„åŸæ ·é€ä¼ ã€‚

3.  **æ•°æ®æ›´æ–°ä¸¢å¤± ID ("Not Set" é—®é¢˜)**
    *   **é—®é¢˜**: åœ¨åå°ç¼–è¾‘è¾©é¢˜åï¼Œåˆ—è¡¨æ˜¾ç¤º "ID: æœªè®¾ç½®"ï¼Œå¯¼è‡´åç»­æ“ä½œå¤±è´¥ã€‚
    *   **åŸå› **: å‰ç«¯æäº¤çš„æ›´æ–° Payload ä¸­ä¸åŒ…å« IDï¼Œåç«¯ Mock æœåŠ¡ç›´æ¥è¦†ç›–å¯¹è±¡å¯¼è‡´ ID å­—æ®µä¸º nullã€‚
    *   **è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹ `MockDataService` çš„æ›´æ–°é€»è¾‘ï¼Œå¦‚æœè¾“å…¥å¯¹è±¡ ID ä¸ºç©ºï¼Œåˆ™ä¿ç•™åŸå¯¹è±¡çš„ IDã€‚

### æœ¬åœ°è”è°ƒçš„ç»éªŒ
- **CURL æ˜¯ç¥å…µåˆ©å™¨**: åœ¨æµè§ˆå™¨è°ƒè¯• WebSocket å›°éš¾æ—¶ï¼Œä½¿ç”¨ `curl -i -N -H "Connection: Upgrade" ...` èƒ½æ¸…æ™°çœ‹åˆ°æ¡æ‰‹å“åº”å¤´ï¼Œå¿«é€Ÿå®šä½æ˜¯ Gateway æ‹’ç»è¿˜æ˜¯ Backend æ‹’ç»ã€‚
- **æ—¥å¿—åˆ†å±‚**: åœ¨ Gateway å¼€å¯ `logLevel: 'debug'`ï¼Œåœ¨ Spring Boot å¼€å¯ `logging.level.web=DEBUG`ï¼Œä¸¤è¾¹å¯¹ç…§æ—¥å¿—èƒ½è¿…é€Ÿå‘ç°è¯·æ±‚è½¬å‘ä¸­çš„è·¯å¾„æˆ–å‚æ•°ä¸¢å¤±é—®é¢˜ã€‚

### éƒ¨ç½²æ­¥éª¤ä¸è¸©å‘è®°å½•
1.  **å¯åŠ¨åç«¯**: `cd backend && mvn spring-boot:run` (ç¡®ä¿ 8081 ç«¯å£ç©ºé—²)ã€‚
2.  **å¯åŠ¨ç½‘å…³**: `cd gateway && npm install && node gateway.js` (ç¡®ä¿ 8080 ç«¯å£ç©ºé—²)ã€‚
3.  **è¸©å‘**: 
    - ç¡®ä¿ `node_modules` æ˜¯æœ€æ–°çš„ï¼Œç‰¹åˆ«æ˜¯ `http-proxy-middleware` ç‰ˆæœ¬å·®å¼‚å¤§ã€‚
    - Windows ä¸‹å¦‚æœç«¯å£è¢«å ç”¨ï¼Œä½¿ç”¨ `netstat -ano | findstr <port>` æŸ¥æ‰¾ PID å¹¶æ€æ‰è¿›ç¨‹ã€‚

## ğŸ§ ä¸ªäººä»‹ç»

- **è§’è‰²**: å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ (Java/Node.js)
- **æ“…é•¿**: Spring Boot å¾®æœåŠ¡æ¶æ„ã€WebSocket å®æ—¶é€šä¿¡ã€å¼‚æ„ç³»ç»Ÿé›†æˆã€‚
- **æœ¬æ¬¡æµ‹è¯•æ„Ÿæ‚Ÿ**: åœ¨å¤„ç†å³æœ‰ç³»ç»Ÿæ”¹é€ æ—¶ï¼Œä¿æŒå¯¹æ—§æ¶æ„ï¼ˆNode ç½‘å…³ï¼‰çš„å…¼å®¹æ€§ä¸å¼•å…¥æ–°æ¶æ„ï¼ˆJava åç«¯ï¼‰çš„ç¨³å®šæ€§ä¹‹é—´éœ€è¦ç²¾ç»†çš„é…ç½®ï¼Œç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œåè®®ï¼ˆWebSocketï¼‰çš„ä»£ç†å±‚é¢ã€‚



# éƒ¨ç½²æŒ‡å— (Deployment Guide)

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•å°†ç›´æ’­è¾©è®ºç³»ç»Ÿï¼ˆGateway + Backend + Frontendï¼‰éƒ¨ç½²åˆ° Linux æœåŠ¡å™¨ã€‚

## 1. ç¯å¢ƒå‡†å¤‡ (Prerequisites)

æœåŠ¡å™¨éœ€å®‰è£…ä»¥ä¸‹è½¯ä»¶ï¼š

*   **Java**: JDK 17 æˆ–æ›´é«˜ç‰ˆæœ¬
    ```bash
    java -version
    ```
*   **Node.js**: v18+ (æ¨è)
    ```bash
    node -v
    ```
*   **Maven**: ç”¨äºæ„å»º Java åç«¯
    ```bash
    mvn -v
    ```
*   **PM2**: ç”¨äºè¿›ç¨‹ç®¡ç†
    ```bash
    npm install -g pm2
    ```

## 2. æ„å»ºé¡¹ç›® (Build)

### 2.1 æ„å»º Java åç«¯

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š

```bash
cd backend
mvn clean package -DskipTests
cd ..
```

æˆåŠŸåï¼Œåº”åœ¨ `backend/target` ç›®å½•ä¸‹çœ‹åˆ° `livedebate-0.0.1-SNAPSHOT.jar`ã€‚

### 2.2 å®‰è£… Gateway ä¾èµ–

```bash
cd gateway
npm install
cd ..
```

## 3. å¯åŠ¨æœåŠ¡ (Start Services)

æœ¬é¡¹ç›®ä½¿ç”¨ `PM2` ç»Ÿä¸€ç®¡ç† Gateway å’Œ Backend æœåŠ¡ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œç¡®ä¿å·²åˆ›å»º `ecosystem.config.js`ï¼ˆå·²åŒ…å«åœ¨ä»£ç åº“ä¸­ï¼‰ï¼Œç„¶åæ‰§è¡Œï¼š

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
pm2 start ecosystem.config.js

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs
```

## 4. éªŒè¯éƒ¨ç½² (Verify)

*   **Gateway (å…¥å£)**: `http://<æœåŠ¡å™¨IP>:8080`
    *   API ä»£ç†: `http://<æœåŠ¡å™¨IP>:8080/api/...`
    *   WebSocket ä»£ç†: `ws://<æœåŠ¡å™¨IP>:8080/ws`
    *   åå°ç®¡ç†: `http://<æœåŠ¡å™¨IP>:8080/admin`
*   **Backend (å†…éƒ¨)**: `http://localhost:8081` (é€šå¸¸ä¸å¯¹å¤–æš´éœ²)

## 5. å¸¸è§é—®é¢˜

### WebSocket è¿æ¥å¤±è´¥
ç¡®ä¿æœåŠ¡å™¨é˜²ç«å¢™å¼€æ”¾äº† **8080** ç«¯å£ã€‚
å¦‚æœä½¿ç”¨ Nginx åå‘ä»£ç†ï¼Œè¯·é…ç½® Upgrade å¤´ï¼š

```nginx
location /ws {
    proxy_pass http://127.0.0.1:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

### æ•°æ®åº“è¿æ¥
ç›®å‰åç«¯ä½¿ç”¨ H2 å†…å­˜æ•°æ®åº“/æ¨¡æ‹Ÿæ•°æ®ã€‚å¦‚éœ€è¿æ¥çœŸå® MySQLï¼Œè¯·ä¿®æ”¹ `backend/src/main/resources/application.properties`ã€‚
